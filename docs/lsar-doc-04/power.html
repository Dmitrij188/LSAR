<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LSAR-DOC-04 Электрическая схема — питание стенда ЛСАР</title>
  <link rel="stylesheet" href="../../assets/css/styles.css" />
</head>
<body class="power-page">
  <header>
    <div class="header-row">
      <h1>LSAR-DOC-04 Электрическая схема — питание стенда ЛСАР</h1>
      <nav class="main-nav">
        <button class="nav-link" onclick="window.location.href='../../index.html'">Основное приложение</button>
        <button class="nav-link" onclick="window.location.href='../../index.html#tab-interactive-schemes'">Интерактивные схемы</button>
      </nav>
    </div>
  </header>

  <div class="container">
    <section class="card hero-card">
      <p class="eyebrow">Интерактивные схемы питания</p>
      <h2>Питание стенда ЛСАР: утверждённая архитектура и обязательные требования</h2>
      <p class="section-lead">Страница фиксирует единственную архитектуру питания и набор обязательных защит. Наведите курсор на элементы, чтобы увидеть простое объяснение и точные требования.</p>
      <div class="toc">
        <a class="toc-btn" href="#section-a">A. Архитектура питания</a>
        <a class="toc-btn" href="#section-b">B. Защиты и аварийное отключение</a>
        <a class="toc-btn" href="#section-c">C. Управление нагрузками</a>
        <a class="toc-btn" href="#section-d">D. Требования безопасности</a>
      </div>
    </section>

    <section id="section-a" class="card">
      <div class="section-heading">
        <h2>A) Архитектура питания (утверждённая)</h2>
        <div class="info-tooltip section-info-tooltip">
          <button class="section-info-button" type="button" aria-label="Пояснение для раздела A">!</button>
          <div class="node-tooltip">
            <div class="tooltip-text">Этот раздел простыми словами объясняет, как электричество попадает в стенд и превращается в понятные и безопасные линии питания. Физически это путь от ввода 230 В на стенде к блоку питания и далее к разным шинам внутри корпуса и на плате управления. Он нужен, чтобы было ясно, откуда берутся 12 В, 24 В и 5 В и почему они разделены по задачам. Если этой логики не будет, питание окажется «смешанным», что приведёт к перегрузкам и нестабильной работе узлов. Такое деление сделано специально, чтобы каждую нагрузку кормить подходящим напряжением и сохранять безопасность.</div>
          </div>
        </div>
      </div>
      <p class="note">Ниже приведена единственная архитектура питания стенда ЛСАР. Другие архитектуры не допускаются в рамках данного проекта.</p>
      <div class="power-layout">
        <div class="power-diagram-panel">
          <div class="diagram-canvas" id="powerDiagram">
            <svg class="diagram-arrows" viewBox="0 0 100 100" preserveAspectRatio="none">
              <defs>
                <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
                  <path d="M0,0 L6,3 L0,6 Z" fill="#3a6bc9"></path>
                </marker>
              </defs>
            </svg>
            <div class="diagram-nodes" id="powerDiagramNodes"></div>
          </div>
          <div class="power-estop">
            <div class="diagram-node node-safety info-tooltip">
              E-Stop (аппаратный аварийный разрыв)
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Аварийная кнопка, физически разрывающая питание силовых ветвей. Нужна для немедленного безопасного отключения при аварии.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">Должна отключать нагреватель и насос аппаратно. Программное отключение не заменяет E-Stop.</div>
              </div>
            </div>
            <p class="scheme-note">E-Stop должен обесточивать силовые ветви независимо от состояния прошивки и управляющей логики.</p>
          </div>
        </div>
        <aside class="card power-details-panel">
          <div class="details-header">
            <p class="eyebrow">Выбранный элемент</p>
            <h3 id="detailsTitle"></h3>
            <p class="details-subtitle" id="detailsSubtitle"></p>
          </div>
          <div class="details-grid" id="detailsContent"></div>
        </aside>
      </div>
    </section>

    <section id="section-b" class="card">
      <div class="section-heading">
        <h2>B) Защиты и аварийное отключение (обязательные)</h2>
        <div class="info-tooltip section-info-tooltip">
          <button class="section-info-button" type="button" aria-label="Пояснение для раздела B">!</button>
          <div class="node-tooltip">
            <div class="tooltip-text">Этот раздел про «страховки» питания: элементы, которые отключают или глушат аварии. Они физически стоят на входе 12 В, на отдельных ветвях и рядом с силовыми линиями внутри корпуса. Зачем это нужно: чтобы поломка одного узла не выводила из строя весь стенд и чтобы скачки напряжения не повреждали электронику. Если защит не будет, при коротком замыкании или броске тока можно потерять сразу всё питание и повредить оборудование. Это сделано так, потому что локальные защиты быстрее и безопаснее ограничивают проблему на месте.</div>
          </div>
        </div>
      </div>
      <p class="note">Защиты строятся селективно, чтобы авария в одной ветви не отключала всю систему.</p>

      <div class="power-flow">
        <div class="diagram-node node-rail info-tooltip">
          Ввод 12 В: 20–25 А
          <div class="node-tooltip">
            <div class="tooltip-title">Что это</div>
            <div class="tooltip-text">Вводной предохранитель/автомат на линии 12 В. Нужен для защиты общего источника питания при перегрузке.</div>
            <div class="tooltip-title">Требование</div>
            <div class="tooltip-text">Номинал 20–25 А, отключение при перегрузке или КЗ обязательно.</div>
          </div>
        </div>
        <div class="flow-arrow">→</div>
        <div class="power-branch-grid">
          <div class="power-branch">
            <div class="power-branch-title">Нагреватель</div>
            <div class="diagram-node node-safety info-tooltip">
              Ветвь нагревателя: 10–15 А
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Отдельный предохранитель для ветви 12V_PWR. Нужен для локализации аварий в нагревателе.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">Номинал 10–15 А. Селективность с вводом обязательна.</div>
              </div>
            </div>
          </div>
          <div class="power-branch">
            <div class="power-branch-title">Boost (вход 12 В)</div>
            <div class="diagram-node node-safety info-tooltip">
              Ветвь Boost: ~10 А
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Ограничение тока для входа повышающего преобразователя. Нужно для защиты общего 12 В ввода.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">Ограничение ~10 А, селективность с вводным автоматом обязательна.</div>
              </div>
            </div>
          </div>
          <div class="power-branch">
            <div class="power-branch-title">Логика 5 В</div>
            <div class="diagram-node node-safety info-tooltip">
              Ветвь 5 В: 2–3 А
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Предохранитель для линии 5V_CTRL. Нужен для защиты электроники от короткого замыкания.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">Номинал 2–3 А. Селективность с вводом обязательна.</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="power-protection-notes">
        <div class="power-protection-card info-tooltip">
          TVS на 12 В и 24 В
          <div class="node-tooltip">
            <div class="tooltip-title">Что это</div>
            <div class="tooltip-text">TVS — защитный диод, который гасит короткие всплески напряжения. Нужен для защиты питания от перенапряжений.</div>
            <div class="tooltip-title">Требование</div>
            <div class="tooltip-text">TVS должен быть установлен на шинах 12 В и 24 В.</div>
          </div>
        </div>
        <div class="power-protection-card info-tooltip">
          PE/заземление корпуса
          <div class="node-tooltip">
            <div class="tooltip-title">Что это</div>
            <div class="tooltip-text">Защитный проводник, соединяющий металлический корпус с землёй. Нужен для безопасности при пробое изоляции.</div>
            <div class="tooltip-title">Требование</div>
            <div class="tooltip-text">PE должен быть подключён к корпусу при БП класса I. Отсутствие PE запрещено.</div>
          </div>
        </div>
        <div class="power-protection-card info-tooltip">
          EMI-фильтр на входе
          <div class="node-tooltip">
            <div class="tooltip-title">Что это</div>
            <div class="tooltip-text">Фильтр, снижающий помехи от силовых цепей в сеть и в электронику. Нужен для устойчивой работы и соответствия нормам помех.</div>
            <div class="tooltip-title">Требование</div>
            <div class="tooltip-text">EMI-фильтр должен быть предусмотрен на входе 230 В.</div>
          </div>
        </div>
        <div class="power-protection-card info-tooltip">
          E-Stop: разрыв силовых ветвей
          <div class="node-tooltip">
            <div class="tooltip-title">Что это</div>
            <div class="tooltip-text">Аппаратное отключение питания нагревателя и насоса одной кнопкой. Нужен для безопасной остановки при аварии.</div>
            <div class="tooltip-title">Требование</div>
            <div class="tooltip-text">E-Stop должен разрывать силовые ветви, а не только сигнал управления.</div>
          </div>
        </div>
      </div>
    </section>

    <section id="section-c" class="card">
      <div class="section-heading">
        <h2>C) Управление нагрузками (обязательное)</h2>
        <div class="info-tooltip section-info-tooltip">
          <button class="section-info-button" type="button" aria-label="Пояснение для раздела C">!</button>
          <div class="node-tooltip">
            <div class="tooltip-text">Этот раздел объясняет, как стенд включает и регулирует свои основные «потребители» — нагреватель и насос. Физически это электронные ключи и управляющая плата внутри корпуса, которые подают питание на силовые линии. Это нужно, чтобы точно дозировать мощность нагревателя и надёжно включать насос по командам контроллера. Если управления не будет, нагрузка станет либо постоянно включённой, либо будет работать рывками и с перегревом. Такой подход выбран, потому что электронные ключи дают плавное, быстрое и безопасное управление без механических реле.</div>
          </div>
        </div>
      </div>
      <p class="note">Управление выполняется электронными ключами. Релейные переключения в силовых ветвях запрещены.</p>

      <div class="power-control-grid">
        <div class="power-control-card">
          <h3>Нагреватель: MOSFET-ключ + PWM (ШИМ)</h3>
          <div class="power-chip-row">
            <div class="power-protection-card info-tooltip">
              PWM/ШИМ
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Быстрое включение и выключение сигнала. Нужен для плавной регулировки мощности без перегрева.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">PWM/ШИМ должен применяться для управления нагревателем.</div>
              </div>
            </div>
          </div>
          <div class="power-flow">
            <div class="diagram-node node-control info-tooltip">
              ESP32
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Микроконтроллер, который управляет мощностью нагревателя. Нужен для формирования управляющего PWM сигнала.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">Выдаёт PWM/ШИМ сигнал для регулирования мощности нагрева.</div>
              </div>
            </div>
            <div class="flow-arrow">→</div>
            <div class="diagram-node node-control info-tooltip">
              MOSFET-ключ
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Электронный выключатель, который быстро включает и выключает ток. Нужен для точного управления мощностью.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">Vds ≥ 40–60 В, токовый запас 3–5×, тепловой отвод обязателен.</div>
              </div>
            </div>
            <div class="flow-arrow">→</div>
            <div class="diagram-node node-load info-tooltip">
              Нагреватель 12 В
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Тепловая нагрузка стенда, требующая плавной регулировки мощности. Нужна для нагрева воды по заданному режиму.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">PWM/ШИМ обязателен. Предохранитель 10–15 А обязателен.</div>
              </div>
            </div>
          </div>
          <p class="scheme-note">PWM (ШИМ) — это быстрое включение/выключение для регулировки мощности. Оно снижает перегрев и повышает стабильность температуры.</p>
        </div>

        <div class="power-control-card">
          <h3>Насос 24 В: включение/выключение</h3>
          <div class="power-flow">
            <div class="diagram-node node-control info-tooltip">
              ESP32
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Контроллер включает и отключает насос по условиям работы стенда. Нужен для поддержания циркуляции.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">Логика ON/OFF обязательна, управление через силовой ключ.</div>
              </div>
            </div>
            <div class="flow-arrow">→</div>
            <div class="diagram-node node-control info-tooltip">
              MOSFET-ключ
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Электронный выключатель для питания насоса. Нужен для надёжной коммутации нагрузки.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">Vds ≥ 60 В, токовый запас 3–5×. Тепловой отвод обязателен.</div>
              </div>
            </div>
            <div class="flow-arrow">→</div>
            <div class="diagram-node node-load info-tooltip">
              Насос 24 В
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Двигатель для циркуляции воды. Нужен для движения воды через стенд.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">Номинал 2 А, пик до 4 А. Защита от выбросов обязательна.</div>
              </div>
            </div>
            <div class="flow-arrow">→</div>
            <div class="diagram-node compact node-safety info-tooltip">
              TVS/flyback
              <div class="node-tooltip">
                <div class="tooltip-title">Что это</div>
                <div class="tooltip-text">Защита от импульсных скачков напряжения, которые возникают в индуктивной нагрузке. Нужна для защиты ключа и питания.</div>
                <div class="tooltip-title">Требование</div>
                <div class="tooltip-text">TVS или flyback-диод должны быть установлены рядом с насосом.</div>
              </div>
            </div>
          </div>
          <p class="scheme-note">Режим управления фиксирован: насос должен работать в режиме включение/выключение без иных режимов.</p>
        </div>
      </div>
    </section>

    <section id="section-d" class="card">
      <div class="section-heading">
        <h2>D) Требования безопасности (чек-лист)</h2>
        <div class="info-tooltip section-info-tooltip">
          <button class="section-info-button" type="button" aria-label="Пояснение для раздела D">!</button>
          <div class="node-tooltip">
            <div class="tooltip-text">Этот раздел — краткое объяснение базовых правил безопасности для всего стенда. Они относятся к тому, что находится внутри корпуса, на плате управления и в силовой части, где проходит питание. Это нужно, чтобы человек не получил поражение током, а оборудование не перегревалось и не повреждалось. Если эти правила игнорировать, любое обслуживание или авария могут стать опасными и привести к серьёзным поломкам. Такой список сделан, потому что безопасность важнее удобства, и эти пункты проверяются первыми.</div>
          </div>
        </div>
      </div>
      <p class="note">Все требования обязательны к исполнению.</p>

      <div class="checklist-grid">
        <div class="checklist-card">
          <div class="checklist-title">Цепи SELV ≤ 24 В DC</div>
          <div class="checklist-text">Что это: безопасные сверхнизкие напряжения внутри стенда.</div>
          <div class="checklist-text">Зачем: снижают риск поражения током.</div>
          <div class="checklist-text">Требование: все внутренние цепи должны быть ≤ 24 В DC, сетевые цепи конструктивно отделены.</div>
        </div>
        <div class="checklist-card">
          <div class="checklist-title">PE/заземление металлических частей</div>
          <div class="checklist-text">Что это: защитное соединение корпуса с землёй.</div>
          <div class="checklist-text">Зачем: отводит ток при пробое и защищает пользователя.</div>
          <div class="checklist-text">Требование: PE должен быть подключён при БП класса I. Отсутствие PE запрещено.</div>
        </div>
        <div class="checklist-card">
          <div class="checklist-title">Интерлок по расходу/уровню</div>
          <div class="checklist-text">Что это: блокировка нагрева без воды или циркуляции.</div>
          <div class="checklist-text">Зачем: предотвращает перегрев и повреждение стенда.</div>
          <div class="checklist-text">Требование: нагрев без подтверждённого расхода/уровня запрещён.</div>
        </div>
        <div class="checklist-card">
          <div class="checklist-title">Два уровня отключения</div>
          <div class="checklist-text">Что это: программное отключение и аппаратный E-Stop.</div>
          <div class="checklist-text">Зачем: аварийная остановка должна работать даже при сбое ПО.</div>
          <div class="checklist-text">Требование: оба уровня должны быть реализованы и независимы.</div>
        </div>
        <div class="checklist-card">
          <div class="checklist-title">Маркировка шин питания</div>
          <div class="checklist-text">Что это: обозначение линий 12V_PWR, 24V_PUMP, 5V_CTRL, GND, PE.</div>
          <div class="checklist-text">Зачем: исключает ошибки при обслуживании и сборке.</div>
          <div class="checklist-text">Требование: маркировка должна быть нанесена на проводах и клеммах.</div>
        </div>
        <div class="checklist-card">
          <div class="checklist-title">Сечения проводов и разъёмы по току</div>
          <div class="checklist-text">Что это: правильный подбор кабелей и коннекторов под нагрузку.</div>
          <div class="checklist-text">Зачем: предотвращает перегрев и оплавление контактов.</div>
          <div class="checklist-text">Требование: слабые разъёмы на силовых ветвях запрещены.</div>
        </div>
      </div>
    </section>
  </div>
  <script>
    const powerNodes = [
      {
        id: 'mains_230vac',
        title: 'Розетка 230 В AC, 50 Гц',
        imageSrc: './mains_230vac.png',
        className: 'node-ac',
        position: { x: 10, y: 18 },
        tooltip: {
          what: 'Переменное напряжение из розетки. Нужно для питания всего стенда и формирует входной уровень сети.',
          requirement: 'Диапазон 207–253 В, 50 Гц. Отклонения вне диапазона запрещены для работы стенда.'
        },
        details: {
          subtitle: 'Ввод сетевого питания',
          summary: 'Сетевое напряжение поступает с внешней розетки и является единственным входом питания стенда.',
          requirements: ['Диапазон 207–253 В, 50 Гц.', 'Отклонения вне диапазона запрещены для работы стенда.'],
          notes: 'Сетевой ввод отделён от внутренних SELV-цепей и требует отдельной защиты.'
        }
      },
      {
        id: 'psu_acdc_12v',
        title: 'AC/DC источник 12 В (SELV), 20 А',
        imageSrc: './psu_acdc_12v.png',
        className: 'node-converter',
        position: { x: 28, y: 18 },
        tooltip: {
          what: 'Блок питания, который превращает 230 В AC в безопасные 12 В DC. SELV означает «безопасное сверхнизкое напряжение» для человека и нужно для защиты пользователя.',
          requirement: '12 В, ≥20 А (≥240 Вт). Защиты OCP/OVP/OTP/SCP обязательны.'
        },
        details: {
          subtitle: 'Ключевой источник 12 В',
          summary: 'Обеспечивает все внутренние линии 12 В и отделяет сеть от безопасных цепей.',
          requirements: ['12 В, ≥20 А (≥240 Вт).', 'Защиты OCP/OVP/OTP/SCP обязательны.'],
          notes: 'SELV подтверждает безопасный уровень напряжения для пользователя.'
        }
      },
      {
        id: 'bus_12v_pwr',
        title: 'Шина 12V_PWR',
        imageSrc: './bus_12v_pwr.png',
        className: 'node-rail',
        position: { x: 46, y: 18 },
        tooltip: {
          what: 'Главная внутренняя шина 12 В, от которой питаются силовая ветвь нагревателя и преобразователи.',
          requirement: 'Маркировка 12V_PWR обязательна. Вводной ток рассчитывается под суммарную нагрузку.'
        },
        details: {
          subtitle: 'Главная силовая шина',
          summary: 'Собирает 12 В после БП и раздаёт питание на три основные ветви стенда.',
          requirements: ['Маркировка 12V_PWR обязательна.', 'Вводной ток 20–25 А должен покрывать суммарную нагрузку.'],
          notes: 'От этой точки выполняется разветвление на Boost, Buck и силовой ключ нагревателя.'
        }
      },
      {
        id: 'dcdc_boost_12_24',
        title: 'DC/DC Boost 12→24 В',
        imageSrc: './dcdc_boost_12_24.png',
        className: 'node-converter',
        position: { x: 28, y: 42 },
        tooltip: {
          what: 'Повышающий преобразователь, который из 12 В делает 24 В для насоса. Нужен для питания насоса без перегрузки 12 В линии.',
          requirement: 'Выход 24 В, ≥5 А, КПД ≥0.9. Входной ток до ~9 А допускается кратковременно.'
        },
        details: {
          subtitle: 'Преобразователь для насоса',
          summary: 'Повышает 12 В до 24 В, чтобы насос работал в своём номинальном режиме.',
          requirements: ['Выход 24 В, ≥5 А, КПД ≥0.9.', 'Входной ток до ~9 А допускается кратковременно.'],
          notes: 'Повышение напряжения снижает нагрузку на 12 В линию при работе насоса.'
        }
      },
      {
        id: 'bus_24v_pump',
        title: 'Шина 24V_PUMP',
        imageSrc: './bus_24v_pump.png',
        className: 'node-rail',
        position: { x: 28, y: 59 },
        tooltip: {
          what: 'Шина — общий провод питания для группы устройств. Нужна для распределения 24 В только на насос.',
          requirement: 'Маркировка 24V_PUMP обязательна, ток по ветви рассчитывается под насос.'
        },
        details: {
          subtitle: 'Линия питания насоса',
          summary: 'Выделенная 24 В шина, к которой подключается только насос и его защита.',
          requirements: ['Маркировка 24V_PUMP обязательна.', 'Ток по ветви рассчитывается под насос.'],
          notes: 'Отдельная шина облегчает диагностику и защищает другие цепи.'
        }
      },
      {
        id: 'pump_24v',
        title: 'Насос 24 В',
        imageSrc: './pump_24v.png',
        className: 'node-load',
        position: { x: 28, y: 76 },
        tooltip: {
          what: 'Электродвигатель, создающий циркуляцию воды в контуре. Нужен для постоянного потока через стенд.',
          requirement: '2 А ном, до 4 А пик. Защита от выбросов (TVS/flyback) обязательна.'
        },
        details: {
          subtitle: 'Основная нагрузка контура',
          summary: 'Обеспечивает циркуляцию воды и поддерживает тепловой режим стенда.',
          requirements: ['2 А ном, до 4 А пик.', 'Защита от выбросов (TVS/flyback) обязательна.'],
          notes: 'Насос управляется режимом включение/выключение без ШИМ.'
        }
      },
      {
        id: 'mosfet_power_switch',
        title: 'MOSFET-ключ',
        imageSrc: './mosfet_power_switch.png',
        className: 'node-control',
        position: { x: 55, y: 42 },
        tooltip: {
          what: 'Электронный выключатель, который быстро включает и выключает ток. Нужен для точного управления мощностью.',
          requirement: 'Vds ≥ 40–60 В, токовый запас 3–5×, тепловой отвод обязателен.'
        },
        details: {
          subtitle: 'Силовой ключ нагревателя',
          summary: 'Коммутирует ток нагревателя под управлением контроллера и обеспечивает ШИМ-регулирование.',
          requirements: ['Vds ≥ 40–60 В.', 'Токовый запас 3–5×.', 'Тепловой отвод обязателен.'],
          notes: 'Релейное управление запрещено — используется только электронный ключ.'
        }
      },
      {
        id: 'heater_12v',
        title: 'Нагреватель 12 В',
        imageSrc: './heater_12v.png',
        className: 'node-load',
        position: { x: 55, y: 59 },
        tooltip: {
          what: 'Нагревательный элемент, превращающий электричество в тепло. Нужен для нагрева воды в контуре.',
          requirement: 'Мощность 80–100 Вт, ток 6.7–8.3 А. MOSFET-ключ + PWM обязателен, предохранитель 10–15 А.'
        },
        details: {
          subtitle: 'Силовая тепловая нагрузка',
          summary: 'Отвечает за нагрев рабочей среды и требует точного управления мощностью.',
          requirements: ['Мощность 80–100 Вт, ток 6.7–8.3 А.', 'MOSFET-ключ + PWM обязателен.', 'Предохранитель 10–15 А обязателен.'],
          notes: 'Нагрев запрещён при отсутствии циркуляции воды.'
        }
      },
      {
        id: 'dcdc_buck_12_5',
        title: 'DC/DC Buck 12→5 В',
        imageSrc: './dcdc_buck_12_5.png',
        className: 'node-converter',
        position: { x: 80, y: 42 },
        tooltip: {
          what: 'Понижающий преобразователь, который делает 5 В для электроники. Нужен для безопасного питания микроконтроллера.',
          requirement: 'Выход 5 В, ≥3 А. Стабилизация напряжения обязательна.'
        },
        details: {
          subtitle: 'Питание логики',
          summary: 'Формирует стабильные 5 В для микроконтроллера и датчиков.',
          requirements: ['Выход 5 В, ≥3 А.', 'Стабилизация напряжения обязательна.'],
          notes: 'Любые просадки питания на логике запрещены.'
        }
      },
      {
        id: 'bus_5v_ctrl',
        title: 'Шина 5V_CTRL',
        imageSrc: './bus_5v_ctrl.png',
        className: 'node-rail',
        position: { x: 80, y: 59 },
        tooltip: {
          what: 'Отдельная линия питания логики. Нужна для стабильного питания контроллера и датчиков.',
          requirement: 'Маркировка 5V_CTRL обязательна. Отделение от силовых линий обязательно.'
        },
        details: {
          subtitle: 'Логическая шина',
          summary: 'Разводит 5 В только на управляющую электронику без силовых нагрузок.',
          requirements: ['Маркировка 5V_CTRL обязательна.', 'Отделение от силовых линий обязательно.'],
          notes: 'Используется для питания контроллера и датчиков.'
        }
      },
      {
        id: 'esp32_sensors',
        title: 'ESP32 + датчики',
        imageSrc: './esp32_sensors.png',
        className: 'node-control',
        position: { x: 80, y: 76 },
        tooltip: {
          what: 'Контроллер и датчики, управляющие стендом и считывающие параметры. Нужны для управления и контроля процессов.',
          requirement: 'Питание 5 В с запасом по току для пиков Wi‑Fi. Просадки напряжения запрещены.'
        },
        details: {
          subtitle: 'Управление и телеметрия',
          summary: 'Контроллер формирует управляющие сигналы и собирает данные с датчиков.',
          requirements: ['Питание 5 В с запасом по току для пиков Wi‑Fi.', 'Просадки напряжения запрещены.'],
          notes: 'Все управляющие цепи питаются исключительно от 5V_CTRL.'
        }
      }
    ];

    const powerEdges = [
      { from: 'mains_230vac', to: 'psu_acdc_12v' },
      { from: 'psu_acdc_12v', to: 'bus_12v_pwr' },
      { from: 'bus_12v_pwr', to: 'dcdc_boost_12_24' },
      { from: 'dcdc_boost_12_24', to: 'bus_24v_pump' },
      { from: 'bus_24v_pump', to: 'pump_24v' },
      { from: 'bus_12v_pwr', to: 'mosfet_power_switch' },
      { from: 'mosfet_power_switch', to: 'heater_12v' },
      { from: 'bus_12v_pwr', to: 'dcdc_buck_12_5' },
      { from: 'dcdc_buck_12_5', to: 'bus_5v_ctrl' },
      { from: 'bus_5v_ctrl', to: 'esp32_sensors' }
    ];

    const diagramNodes = document.getElementById('powerDiagramNodes');
    const diagramSvg = document.querySelector('.diagram-arrows');
    const detailsTitle = document.getElementById('detailsTitle');
    const detailsSubtitle = document.getElementById('detailsSubtitle');
    const detailsContent = document.getElementById('detailsContent');

    const nodeMap = new Map(powerNodes.map((node) => [node.id, node]));

    function renderNodes() {
      diagramNodes.innerHTML = powerNodes.map((node) => `
        <button
          class="diagram-node-card info-tooltip ${node.className}"
          style="--node-x: ${node.position.x}%; --node-y: ${node.position.y}%;"
          type="button"
          data-node-id="${node.id}"
          aria-pressed="false"
        >
          <img src="${node.imageSrc}" alt="${node.title}" />
          <span>${node.title}</span>
          <div class="node-tooltip">
            <div class="tooltip-title">Что это</div>
            <div class="tooltip-text">${node.tooltip.what}</div>
            <div class="tooltip-title">Требование</div>
            <div class="tooltip-text">${node.tooltip.requirement}</div>
          </div>
        </button>
      `).join('');
    }

    function renderEdges() {
      const lines = powerEdges.map((edge) => {
        const from = nodeMap.get(edge.from);
        const to = nodeMap.get(edge.to);
        if (!from || !to) return '';
        return `<line x1="${from.position.x}" y1="${from.position.y}" x2="${to.position.x}" y2="${to.position.y}" stroke="#3a6bc9" stroke-width="0.6" marker-end="url(#arrowhead)" />`;
      }).join('');

      diagramSvg.innerHTML = `
        <defs>
          <marker id="arrowhead" markerWidth="6" markerHeight="6" refX="5" refY="3" orient="auto">
            <path d="M0,0 L6,3 L0,6 Z" fill="#3a6bc9"></path>
          </marker>
        </defs>
        ${lines}
      `;
    }

    function renderDetails(node) {
      detailsTitle.textContent = node.title;
      detailsSubtitle.textContent = node.details.subtitle;
      detailsContent.innerHTML = `
        <div class="details-card">
          <h4>Что это</h4>
          <p>${node.details.summary}</p>
        </div>
        <div class="details-card">
          <h4>Требования</h4>
          <ul>
            ${node.details.requirements.map((item) => `<li>${item}</li>`).join('')}
          </ul>
        </div>
        <div class="details-card">
          <h4>Примечание</h4>
          <p>${node.details.notes}</p>
        </div>
      `;
    }

    function setActiveNode(nodeId) {
      const node = nodeMap.get(nodeId) || powerNodes[0];
      document.querySelectorAll('.diagram-node-card').forEach((element) => {
        const isActive = element.dataset.nodeId === node.id;
        element.classList.toggle('active', isActive);
        element.setAttribute('aria-pressed', isActive ? 'true' : 'false');
      });
      renderDetails(node);
    }

    document.addEventListener('DOMContentLoaded', () => {
      renderNodes();
      renderEdges();
      setActiveNode('bus_12v_pwr');
      diagramNodes.addEventListener('click', (event) => {
        const button = event.target.closest('.diagram-node-card');
        if (!button) return;
        setActiveNode(button.dataset.nodeId);
      });
    });
  </script>
</body>
</html>
